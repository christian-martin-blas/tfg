<div id="popUp" title="Crear forma">
  <div class="container">
    <div id="centralTool">
      <div class="row">
        <div id="designs" class="col-md-3">
          <h4>Formas</h4>
          <div id="imagenesFormas">
            <div id="base1" class="col-md-5" onClick="displayParticiones(this)">
              <img src="./img/bases/Base 1.png"  class="design">
            </div>
            <div id="base2" class="col-md-5" onClick="displayParticiones(this)">
              <img src="./img/bases/Base 2.png" class="design">
            </div>
            <div id="base3" class="col-md-5" onClick="displayParticiones(this)">
              <img src="./img/bases/Base 3.png" class="design">
            </div>
            <div id="base4" class="col-md-5" onClick="displayParticiones(this)">
              <img src="./img/bases/Base 4.png" class="design">
            </div>
            <div id="base5" class="col-md-5" onClick="displayParticiones(this)">
              <img src="./img/bases/Base 5.png" class="design">
            </div>
            <div id="base6" class="col-md-5" onClick="displayParticiones(this)">
              <img src="./img/bases/Base 6.png" class="design">
            </div>
          </div>
          <div id ="particiones1" class="particiones">
            <h4>Particiones</h4>
            <div id="imagenesParticiones">
              <div id="particion11" class="col-md-5" onClick="displayColores(this)">
                <img src="./img/particiones/base 1/Particion 1.jpg" class="design">
              </div>
              <div id="particion12" class="col-md-5" onClick="displayColores(this)">
                <img src="./img/particiones/base 1/Particion 2.jpg" class="design">
              </div>
              <div id="particion13" class="col-md-5" onClick="displayColores(this)">
                <img src="./img/particiones/base 1/Particion 3.jpg" class="design">
              </div>
            </div>
          </div>
          <div id ="particiones2" class="particiones">
            <h4>Particiones</h4>
            <div id="imagenesParticiones">
              <div id="particion21" class="col-md-5" onClick="displayColores(this)">
                <img src="./img/particiones/base 2/Particion 1.jpg" class="design">
              </div>
              <div id="particion22" class="col-md-5" onClick="displayColores(this)">
                <img src="./img/particiones/base 2/Particion 2.jpg" class="design">
              </div>
              <div id="particion23" class="col-md-5" onClick="displayColores(this)">
                <img src="./img/particiones/base 2/Particion 3.jpg" class="design">
              </div>
            </div>
          </div>

          <div id="colorParticion1">
            Partición 1:
            <select id="particion1" name="colorpicker-picker-shortlist"  onchange="changeColor(this);">
              <option value="#F5F5F5">Plata(Blanco)</option>
              <option value="#FCDD09" >Oro(Amarillo)</option>
              <option value="#BFAF3F">Oro</option>
              <option value="#C2C1BD">Plata</option>
              <option value="#008AF0">Azur</option>
              <option value="#FF2611">Gules</option>
              <option value="#07C143">Sinople</option>
              <option value="#000000">Sable</option>
              <option value="#EF61C6">Púrpura</option>
            </select>
          </div>
          <div id="colorParticion2">
            Partición 2:
            <select id="particion2" name="colorpicker-picker-shortlist" onchange="changeColor(this);">
              <option value="#F5F5F5">Plata(Blanco)</option>
              <option value="#FCDD09">Oro(Amarillo)</option>
              <option value="#BFAF3F">Oro</option>
              <option value="#C2C1BD">Plata</option>
              <option value="#008AF0">Azur</option>
              <option value="#FF2611">Gules</option>
              <option value="#07C143">Sinople</option>
              <option value="#000000">Sable</option>
              <option value="#EF61C6">Púrpura</option>
            </select>
          </div>
          <div id="colorParticion3">
            Partición 3:
            <select id="particion3" name="colorpicker-picker-shortlist" onchange="changeColor(this);">
              <option value="#F5F5F5">Plata(Blanco)</option>
              <option value="#FCDD09">Oro(Amarillo)</option>
              <option value="#BFAF3F">Oro</option>
              <option value="#C2C1BD">Plata</option>
              <option value="#008AF0">Azur</option>
              <option value="#FF2611">Gules</option>
              <option value="#07C143">Sinople</option>
              <option value="#000000">Sable</option>
              <option value="#EF61C6">Púrpura</option>
            </select>
          </div>
          <div id="colorParticion4">
            Partición 4:
            <select id="particion4" name="colorpicker-picker-shortlist" onchange="changeColor(this);">
              <option value="#F5F5F5">Plata(Blanco)</option>
              <option value="#FCDD09">Oro(Amarillo)</option>
              <option value="#BFAF3F">Oro</option>
              <option value="#C2C1BD">Plata</option>
              <option value="#008AF0">Azur</option>
              <option value="#FF2611">Gules</option>
              <option value="#07C143">Sinople</option>
              <option value="#000000">Sable</option>
              <option value="#EF61C6">Púrpura</option>
            </select>
          </div>
        </div>
        <div id="previsualization" class="col-md-8">
          <img id="back">
          <img id="part1">
          <img id="part2">
          <img id="part3">
        </div>
      </div>
    </div> 
  </div>
</div>

<script>

var selector =  " <option value='#F5F5F5'>Plata(Blanco)</option> " +
                " <option value='#FCDD09'>Oro(Amarillo)</option> " +
                " <option value='#BFAF3F'>Oro</option> " +
                " <option value='#C2C1BD'>Plata</option> " +
                " <option value='#008AF0'>Azur</option> " +
                " <option value='#FF2611'>Gules</option> " +
                " <option value='#07C143'>Sinople</option> " +
                " <option value='#000000'>Sable</option> " + 
                " <option value='#EF61C6'>Púrpura</option> ";

//Variable para recargar la base original
var srcBack = null;

//Variables para cargar imágenes
  var base = -1;
  var particion = -1;

//Variables de las imagenes
  var backImg = document.getElementById("back");
  var part1Img = document.getElementById("part1");
  var part2Img = document.getElementById("part2");
  var part3Img = document.getElementById("part3");

  var canvas = document.createElement("canvas");
  var ctx = canvas.getContext("2d");

//Variables para el cambio de color
  var originalPixelsBack = null;
  var currentPixelsBack = null;
  var originalPixelsPart1 = null;
  var currentPixelsPart1 = null;
  var originalPixelsPart2 = null;
  var currentPixelsPart2 = null;
  var originalPixelsPart3 = null;
  var currentPixelsPart3 = null;

  function getPixels(img)  {
    console.log("Logger: " + img.id);
    canvas.width = img.width;
    canvas.height = img.height;

    ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, img.width, img.height);
    if(img.id == "back") {
      originalPixelsBack = ctx.getImageData(0, 0, img.width, img.height);
      currentPixelsBack = ctx.getImageData(0, 0, img.width, img.height);
    }
    else if(img.id == "part1") {
      originalPixelsPart1 = ctx.getImageData(0, 0, img.width, img.height);
      currentPixelsPart1 = ctx.getImageData(0, 0, img.width, img.height);
    }
    else if(img.id == "part2") {
      originalPixelsPart2 = ctx.getImageData(0, 0, img.width, img.height);
      currentPixelsPart2 = ctx.getImageData(0, 0, img.width, img.height);
    }
     else if(img.id == "part3") {
      originalPixelsPart3 = ctx.getImageData(0, 0, img.width, img.height);
      currentPixelsPart3 = ctx.getImageData(0, 0, img.width, img.height);
    }
    img.onload = null;
  }

  function resetColor() { 
    var elem1 = document.getElementById("colorParticion1").children[0];
    var elem2 = document.getElementById("colorParticion1").children[1];
    elem1.parentNode.removeChild(elem1);
    elem2.parentNode.removeChild(elem2);
    elem1 = document.getElementById("colorParticion2").children[0];
    elem2 = document.getElementById("colorParticion2").children[1];
    elem1.parentNode.removeChild(elem1);
    elem2.parentNode.removeChild(elem2);
    $('#colorParticion1').append("<select id='particion1' name='colorpicker-picker-shortlist'  onchange='changeColor(this);''>" + selector + "</select>");
    $('#colorParticion2').append("<select id='particion2' name='colorpicker-picker-shortlist'  onchange='changeColor(this);''>" + selector + "</select>");
    if (particion >= 5) {
      elem1 = document.getElementById("colorParticion3").children[0];
      elem2 = document.getElementById("colorParticion3").children[1];
      elem1.parentNode.removeChild(elem1);
      elem2.parentNode.removeChild(elem2);
      elem1 = document.getElementById("colorParticion4").children[0];
      elem2 = document.getElementById("colorParticion4").children[1];
      elem1.parentNode.removeChild(elem1);
      elem2.parentNode.removeChild(elem2);
      $('#colorParticion3').append("<select id='particion3' name='colorpicker-picker-shortlist'  onchange='changeColor(this);''>" + selector + "</select>");
      $('#colorParticion4').append("<select id='particion4' name='colorpicker-picker-shortlist'  onchange='changeColor(this);''>" + selector + "</select>");
    }
    $('select[name="colorpicker-picker-shortlist"]').simplecolorpicker({picker: true, theme: 'glyphicons'});
  }


  function changeColor(select)  {
    //Compruebo que las imagenes se han cargado
    if(select.id == 'particion1' && !originalPixelsBack) return;
    if(select.id == 'particion2' && !originalPixelsPart1) return;
    if(select.id == 'particion3' && !originalPixelsPart2) return;
    if(select.id == 'particion4' && !originalPixelsPart3) return;

    var newColor = {
      R: hexToR(select.value),
      G: hexToG(select.value),
      B: hexToB(select.value),
    };
    if(select.id == 'particion1') {
      console.log(originalPixelsBack);
      for(var I = 0, L = originalPixelsBack.data.length; I < L; I += 4)
      {
        if(currentPixelsBack.data[I + 3] > 0) // If it's not a transparent pixel
        {
            currentPixelsBack.data[I] = originalPixelsBack.data[I] / 255 * newColor.R;
            currentPixelsBack.data[I + 1] = originalPixelsBack.data[I + 1] / 255 * newColor.G;
            currentPixelsBack.data[I + 2] = originalPixelsBack.data[I + 2] / 255 * newColor.B;
        }
      }
      ctx.putImageData(currentPixelsBack, 0, 0);
      backImg.src = canvas.toDataURL("image/png");
    } 
    if(select.id == 'particion2') {
      console.log(originalPixelsPart1);
      for(var I = 0, L = originalPixelsPart1.data.length; I < L; I += 4)
      {
        if(currentPixelsPart1.data[I + 3] > 0) // If it's not a transparent pixel
        {
            currentPixelsPart1.data[I] = originalPixelsPart1.data[I] / 255 * newColor.R;
            currentPixelsPart1.data[I + 1] = originalPixelsPart1.data[I + 1] / 255 * newColor.G;
            currentPixelsPart1.data[I + 2] = originalPixelsPart1.data[I + 2] / 255 * newColor.B;
        }
      }
      ctx.putImageData(currentPixelsPart1, 0, 0);
      part1Img.src = canvas.toDataURL("image/png");
    } 
    if(select.id == 'particion3') {
      for(var I = 0, L = originalPixelsPart2.data.length; I < L; I += 4)
      {
        if(currentPixelsPart2.data[I + 3] > 0) // If it's not a transparent pixel
        {
            currentPixelsPart2.data[I] = originalPixelsPart2.data[I] / 255 * newColor.R;
            currentPixelsPart2.data[I + 1] = originalPixelsPart2.data[I + 1] / 255 * newColor.G;
            currentPixelsPart2.data[I + 2] = originalPixelsPart2.data[I + 2] / 255 * newColor.B;
        }
      }
      ctx.putImageData(currentPixelsPart2, 0, 0);
      part2Img.src = canvas.toDataURL("image/png");
    } 
    if(select.id == 'particion4') {
      for(var I = 0, L = originalPixelsPart3.data.length; I < L; I += 4)
      {
        if(currentPixelsPart3.data[I + 3] > 0) // If it's not a transparent pixel
        {
            currentPixelsPart3.data[I] = originalPixelsPart3.data[I] / 255 * newColor.R;
            currentPixelsPart3.data[I + 1] = originalPixelsPart3.data[I + 1] / 255 * newColor.G;
            currentPixelsPart3.data[I + 2] = originalPixelsPart3.data[I + 2] / 255 * newColor.B;
        }
      }
      ctx.putImageData(currentPixelsPart3, 0, 0);
      part3Img.src = canvas.toDataURL("image/png");
    } 
  }


  $('select[name="colorpicker-picker-shortlist"]').simplecolorpicker({picker: true, theme: 'glyphicons'});


  function displayParticiones(item) {
    var id = item.id;
    var src = item.children[0].src;
    srcBack = src;
    $("#back").attr("src", src);
    //Limpieza de colores y particiones
    if(particion != -1) {
      if(particion != 5) {
        $("#colorParticion1").css("display", "none");
        $("#colorParticion2").css("display", "none");
      }
      else {
        $("#colorParticion1").css("display", "none");
        $("#colorParticion2").css("display", "none");
        $("#colorParticion3").css("display", "none");
        $("#colorParticion4").css("display", "none");
      }
      $("#part1").attr("src", "");
      $("#part2").attr("src", "");
      $("#part3").attr("src", "");
      $("#part4").attr("src", "");
      particion = -1;
    }
    if(base != -1) {
      var particiones = "#particiones" + base;
      $(particiones).css("display", "none");
      base = -1;
    } 
    base = item.id.substr(id.length - 1);
    var particiones = "#particiones" + base;
    $(particiones).css("display", "block");
  }

  function displayColores(item) {
    var id = item.id;
    var src = item.children[0].src;
    //Reset de los colores
    if(particion != -1) {
      $("#back").attr("src", srcBack);
      resetColor(particion);      
      particion = -1;
    }
    particion = item.id.substr(id.length - 1);
    //var colores = "#colores" + base + particion;

    if(particion < 5) {
      var srcPart1 = src.substr(0, src.length - 4) + ".png";
      $("#part1").attr("src", srcPart1);
      $("#colorParticion1").css("display", "block");
      $("#colorParticion2").css("display", "block");
      getPixels(backImg);
      $("#part1").on('load', function(){
        getPixels(part1Img);
      });
    }
    else  {
      var srcPart1 = src.substr(0, src.length - 5) + "6.png";
      var srcPart2 = src.substr(0, src.length - 5) + "7.png";
      var srcPart3 = src.substr(0, src.length - 5) + "8.png";
      $("#part1").attr("src", srcPart1);
      $("#part2").attr("src", srcPart2);
      $("#part3").attr("src", srcPart3);
      $("#colorParticion1").css("display", "block");
      $("#colorParticion2").css("display", "block");
      $("#colorParticion3").css("display", "block");
      $("#colorParticion4").css("display", "block");
      getPixels(backImg);
      $("#part1").on('load', function(){
        getPixels(part1Img);
      });
      $("#part2").on('load', function(){
        getPixels(part2Img);
      });
      $("#part3").on('load', function(){
        getPixels(part3Img);
      });
    }
    
  }

//Funciones para cambiar de hexadecimal a RGB
  function hexToR(h) {return parseInt((cutHex(h)).substring(0,2),16)}
  function hexToG(h) {return parseInt((cutHex(h)).substring(2,4),16)}
  function hexToB(h) {return parseInt((cutHex(h)).substring(4,6),16)}
  function cutHex(h) {return (h.charAt(0)=="#") ? h.substring(1,7):h}

</script>