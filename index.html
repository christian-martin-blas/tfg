<!DOCTYPE HTML>
<meta charset="utf-8"> 
<html>
  <head>
  	  <script src="./lib/js/jquery-1.11.0.min.js"></script>
  	  <link rel="stylesheet" href="./lib/css/redmond/jquery-ui-1.10.4.custom.css">
  	  <link rel="stylesheet" type="text/css" href="./lib/css/bootstrap.css">
      <link rel="stylesheet" type="text/css" href="./lib/css/jquery.simplecolorpicker.css">
      <link rel="stylesheet" type="text/css" href="./lib/css/jquery.simplecolorpicker-glyphicons.css">

  	  <script src="./lib/js/bootstrap.js"></script>
  	  <script src="./lib/js/jquery-ui-1.10.4.custom.js"></script>
      <script src="./lib/js/jquery.simplecolorpicker.js"></script>
      <script src="./lib/js/fabric.js"></script>

  	  <style>
      html {
        max-width: 1500px;
      }
  		.container {
  			background-color: grey;
  			width: 800px;
  		}
  		.page-header {
  			text-align: center;
  		}
  		#designs {
  			height: 100%;
  		}
  		img.design {
  			width: 100%;
  			cursor: pointer;
        padding-bottom: 5px;
  		}
      img {
        max-width: 100%;
        max-height: 100%;
      }
  		#imagenesFormas {
  			background-color: white;
  			height: 100px;
  			width: 100%;
  			overflow-y: scroll;
  		}
  		.particiones {
  			display: none;
  		}
  		#imagenesParticiones {
  			background-color: white;
  			height: 100px;
  			width: 100%;
  			overflow-y: scroll;
  		}
  		.colores {
  			display: none;
  		}
  		#imagenesColores {
  			background-color: white;
  			height: 100px;
  			width: 100%;
  			overflow-y: scroll;
        margin-bottom: 10px;
  		}
  		#previsualization {
  			background-color: white;
  			height: 350px;
  			margin-top: 40px;
        margin-bottom: 40px;
  		}
      #back {
        position: absolute;
        left: 50%;
        top: 50%; 
        margin-left: -110px;
        margin-top: -110px;
      }
      #part1 {
        position: absolute;
        left: 50%;
        top: 50%; 
        margin-left: -110px;
        margin-top: -110px;
      }
      #part2 {
        position: absolute;
        left: 50%;
        top: 50%; 
        margin-left: -110px;
        margin-top: -110px;
      }
      #part3 {
        position: absolute;
        left: 50%;
        top: 50%; 
        margin-left: -110px;
        margin-top: -110px;
      }
      #colorParticion1 {
        padding: 5px;
        display: none;
      }
      #colorParticion2 {
        padding: 5px;
        display: none;
      }
      #colorParticion3 {
        padding: 5px;
        display: none;
      }
      #colorParticion4 {
        padding: 5px;
        display: none;
      }
      #workspace {
        width: 800px;
        height: 350px;
        margin-top: 20px;
        background-color: white;
        display: inline-block;
      }
      #shield {
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-top: 50px;
      }
      #accordion {
        padding: 10px;
        margin-top: 100px;
        width: 100%;
        height: 100%;
        font-size: 12px;
      }
      img.figures {
        height: 100px;
        padding: 5px;
        cursor: pointer;
      }
      .controls { 
        float: left;
        background: #EAF5FE; 
        padding-bottom: 15px; 
        padding-left: 15px; 
        padding-right: 15px; 
        border-right: 5px solid #333333; 
        border-top: 5px solid #333333; 
        border-bottom: 5px solid #333333; 
        height: 350px 
      }
      #mainCanvas {
        border-style: solid;
        border-width: 5px;
      }
      .canvas-container {
        float: left;
      }
      .icons {
        height: 30px;
        width: 30px;
        cursor: pointer;
      }
      .button {
        float: left;
        background: #77AEFF; 
        margin-left: 2px;
        margin-right: 2px;
        margin-bottom: 30px;
        border-bottom: 2px solid;
        border-left: 2px solid;
        border-right: 2px solid;
      }


  	</style>

  </head>
  <body>

    <div id="mainTool">

      <div class="col-md-3">
        <div id="accordion">
          <h3>Imágenes Animales</h3>
          <div id="animales">
            <div id="animal1" class="col-md-5">
              <img id="aguila" src="./img/animales/aguila.png" class="figures" onClick="addImage(this)"/>
            </div>
            <div id="animal2" class="col-md-5">
              <img id="cabrapie" src="./img/animales/cabrapie.png" class="figures" onClick="addImage(this)"/>
            </div>
            <div id="animal3" class="col-md-5">
              <img id="halcon" src="./img/animales/halcon.png" class="figures" onClick="addImage(this)"/>
            </div>
            <div id="animal4" class="col-md-5">
              <img id="leon" src="./img/animales/leon.png" class="figures" onClick="addImage(this)"/>
            </div>
            
          </div>
          <h3>Imágenes Artificiales</h3>
          <div id="artificiales">
            
          </div>
          <h3>Imágenes Humanas</h3>
          <div id="humanas">
          </div>
        </div>
      </div>

      <div class="col-md-7">
        <button id="buttonPopUp" onclick="openPopUp()">Nuevo Escudo</button>
        <button id="buttonPopUp" onclick="openPopUp()">Guardar Escudo</button>
        <button id="buttonPopUp" onclick="openPopUp()">Cargar Escudo</button>
        <div id="workspace">
          <canvas id="mainCanvas" width="530" height="350">
          </canvas>
          <div class="controls">
              <div id="icons">
                <div id="delete" class="button" title="Borrar elemento">
                  <img id="cross" src="./img/icons/crossIcon.png" class="icons" onClick="deleteImage()"/>
                </div>
                <div id="up" class="button" title="Subir elemento">
                  <img id="arrowUp" src="./img/icons/arrowUp.png" class="icons" onClick="bringForward()"/>
                </div>
                <div id="down" class="button" title="Bajar elemento">
                  <img id="arrowDown" src="./img/icons/arrowDown.png" class="icons" onClick="sendBackwards()"/>
                </div>
              </div>
              <p>
                <label><span>Ángulo:</span> <input type="range" id="angle-control" value="0" min="-90" max="90"></label>
              </p>
              <p>
                <label><span>Horizontal:</span> <input type="range" id="left-control" value="150" min="0" max="300"></label>
              </p>
              <p>
                <label><span>Vertical:</span> <input type="range" id="top-control" value="150" min="0" max="300"></label>
              </p>
              <p>
                <label><span>Escala:</span> <input type="range" id="scale-control" value="1" min="0.1" max="3" step="0.1"></label>
              </p>
              <button type="button" onClick="mirrorImage()">Invertir imagen</button>
          </div>
        </div>
      </div>

    </div>

		<div id="popUp" title="Crear forma">	
		</div>

  </body>

  <div id="dialogConfirm" title="¿Deseas borrar el diseño actual?">
    <p>
      <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Se borrará completamente el diseño actual del escudo. 
    </p>
    <b>
      ¿Estás seguro que deseas borrar el diseño?
    </b>

  </div>

  <script>
  //Variables para canvas
  var canvas = document.createElement("canvas");
  var ctx = canvas.getContext("2d");
  var mainCanvas = new fabric.Canvas('mainCanvas');
  var workspace = document.getElementById("workspace");

  $(function(){
    $ ("#popUp").load("popUp.html");
  });


	$("#popUp").dialog({
  		autoOpen: false,
  		height: "auto",
  		width: "auto",
  		modal: true,
  		buttons: {
  			"Crear forma": function() {
          var c = document.getElementById("mainCanvas");
          var mainCtx = c.getContext("2d");          
          if(particion == 1 || particion == -1) {
            mainCtx.drawImage(backImg, 150, 50);
            var src = c.toDataURL("image/png");
            fabric.Image.fromURL(src, function(img) {
              mainCanvas.add(img.set({ left: 0, top: 0, selectable: false, hasControls: false, evented: false}));
            });
          }
          else if(particion < 6) {
            mainCtx.drawImage(backImg, 150, 50);
            mainCtx.drawImage(part1Img, 150, 50);
            var src = c.toDataURL("image/png");
            console.log(src);
            fabric.Image.fromURL(src, function(img) {
              mainCanvas.add(img.set({ left: 0, top: 0, selectable: false, hasControls: false, evented: false}));
            });
          }
          else if(particion == 6) {
            mainCtx.drawImage(backImg, 150, 50);
            mainCtx.drawImage(part1Img, 150, 50);
            mainCtx.drawImage(part2Img, 150, 50);
            mainCtx.drawImage(part3Img, 150, 50);
            var src = c.toDataURL("image/png");
            fabric.Image.fromURL(src, function(img) {
              mainCanvas.add(img.set({ left: 0, top: 0, selectable: false, hasControls: false, evented: false}));
            });
          }
          $( this ).dialog( "close" );
  			},
  			"Cancelar": function() {
  				$( this ).dialog( "close" );
  			}
  		},
      close: function( event, ui ) {
        $("#back").attr("src", "");
        $("#part1").attr("src", "");
        $("#part2").attr("src", "");
        $("#part3").attr("src", "");
        $("#particiones1").css("display", "none");
        $("#particiones2").css("display", "none");
        $("#particiones3").css("display", "none");
        $("#particiones4").css("display", "none");
        $("#particiones5").css("display", "none");
        $("#particiones6").css("display", "none");
        resetColor();
        $("#colorParticion1").css("display", "none");
        $("#colorParticion2").css("display", "none");
        $("#colorParticion3").css("display", "none");
        $("#colorParticion4").css("display", "none");
      }
  	})


    $( "#dialogConfirm" ).dialog({
      autoOpen: false,
      resizable: true,
      height: "auto",
      width: "auto",
      modal: true,
      buttons: {
        "Aceptar": function() {
           while(mainCanvas.item(0) != undefined) {
            mainCanvas.remove(mainCanvas.item(0));
          }
          $( this ).dialog( "close" );
          $("#popUp").dialog("open");
        },
        "Cancelar": function() {
          $( this ).dialog( "close" );
        }
      }
    });


  function openPopUp() {
    if(mainCanvas.item(0) != undefined) {
      $("#dialogConfirm").dialog("open");
    }
  	else 
      $("#popUp").dialog("open");
  }


  $(function() {
    $( "#accordion" ).accordion({

    });
  });

  function addImage(item) {
    var imgElement = document.getElementById(item.id);
    var imgInstance = new fabric.Image(imgElement, {
      left: 150,
      top: 50
    });
    mainCanvas.add(imgInstance);
  }

  function deleteImage() {
    var activeObject = mainCanvas.getActiveObject();
    if (activeObject) {
      mainCanvas.remove(activeObject);
    }
  }

  function bringForward() {
    var activeObject = mainCanvas.getActiveObject();
    if (activeObject) {
      mainCanvas.bringForward(activeObject);
    }
  }

  function sendBackwards() {
    var activeObject = mainCanvas.getActiveObject();
    if (activeObject) {
      mainCanvas.sendBackwards(activeObject);
    }
  }

  function mirrorImage() {
    var activeObject = mainCanvas.getActiveObject();
    if (activeObject) {
      activeObject.set('flipX', true);
      mainCanvas.renderAll();
    }
  }

  var angleControl = $('angle-control');
  angleControl.onchange = function() {
    var activeObject = mainCanvas.getActiveObject();
    activeObject.setAngle(parseInt(this.value, 10)).setCoords();
    mainCanvas.renderAll();
  };

  var scaleControl = $('scale-control');
  scaleControl.onchange = function() {
    var activeObject = mainCanvas.getActiveObject();
    activeObject.scale(parseFloat(this.value)).setCoords();
    mainCanvas.renderAll();
  };

  var topControl = $('top-control');
  topControl.onchange = function() {
    var activeObject = mainCanvas.getActiveObject();
    activeObject.setTop(parseInt(this.value, 10)).setCoords();
    mainCanvas.renderAll();
  };

  var leftControl = $('left-control');
  leftControl.onchange = function() {
    var activeObject = mainCanvas.getActiveObject();
    activeObject.setLeft(parseInt(this.value, 10)).setCoords();
    mainCanvas.renderAll();
  };

  function updateControls() {
    var activeObject = mainCanvas.getActiveObject();
    scaleControl.value = activeObject.getScaleX();
    angleControl.value = activeObject.getAngle();
    leftControl.value = activeObject.getLeft();
    topControl.value = activeObject.getTop();
  }
  mainCanvas.on({
    'object:moving': updateControls,
    'object:scaling': updateControls,
    'object:resizing': updateControls,
    'object:rotating': updateControls
  });

  </script>

</html>
